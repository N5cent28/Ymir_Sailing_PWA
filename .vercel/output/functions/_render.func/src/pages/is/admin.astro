---
import Layout from '../../layouts/Layout.astro';
import Navigation from '../../components/Navigation.astro';
import { getBoatStatus, getActiveCheckIns, getOverdueBoats, getRecentNotifications, updateBoatStatus } from '../../lib/database-postgres.js';

// Get all boat data
const boats = [
  { id: 'boat-1', name: 'Quest 1' },
  { id: 'boat-2', name: 'Quest 2' },
  { id: 'boat-3', name: 'Zest 1' },
  { id: 'boat-4', name: 'Zest 2' },
  { id: 'boat-5', name: 'Zest 3' }
];

const boatStatuses = await Promise.all(boats.map(async (boat) => {
  const status = await getBoatStatus(boat.id);
  const activeCheckIns = await getActiveCheckIns(boat.id);
  return { ...boat, ...status, activeCheckIns };
}));

const overdueBoats = await getOverdueBoats();
const notifications = await getRecentNotifications(20);
---

<Layout title="Stjórnborð - Siglingafélagið Ýmir" lang="is">
  <Navigation />
  
  <main>
    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-ocean-green to-green-600 text-white py-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="text-5xl font-bold mb-6">
          Stjórnborð
        </h1>
        <p class="text-xl mb-8 max-w-3xl mx-auto">
          Stjórnaðu bátastöðu, fylgstu eftir útgáfu og fylgstu félagsstarfi.
        </p>
      </div>
    </section>

    <!-- Dashboard Content -->
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Alerts -->
        {overdueBoats.length > 0 && (
          <div class="mb-8 bg-red-50 border border-red-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-red-900 mb-4">⚠️ Seinir Bátar</h3>
            <div class="space-y-2">
              {overdueBoats.map((boat) => (
                <div class="flex justify-between items-center bg-red-100 p-3 rounded">
                  <div>
                    <span class="font-semibold">{boat.boat_name}</span> - {boat.sailor_name}
                  </div>
                  <div class="text-sm text-red-700">
                    Væntanlegt: {new Date(boat.expected_return).toLocaleString('is-IS')}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Boat Management -->
        <div class="grid lg:grid-cols-2 gap-8 mb-12">
          <!-- Boat Status -->
          <div class="bg-sail-white rounded-lg p-6 shadow-lg">
            <h3 class="text-xl font-bold text-ocean-green mb-6">Bátastöða</h3>
            <div class="space-y-4">
              {boatStatuses.map((boat) => (
                <div class="border rounded-lg p-4">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <h4 class="font-semibold">{boat.name}</h4>
                      <p class="text-sm text-gray-600">ID: {boat.id}</p>
                    </div>
                    <div class="text-right">
                      <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        boat.status === 'operational' ? 'bg-green-100 text-green-800' :
                        boat.status === 'maintenance' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-red-100 text-red-800'
                      }`}>
                        {boat.status === 'operational' ? 'Tilbúinn' :
                         boat.status === 'maintenance' ? 'Viðhald' :
                         'Ekki í notkun'}
                      </span>
                    </div>
                  </div>
                  
                  {boat.notes && (
                    <p class="text-sm text-gray-600 mb-2">{boat.notes}</p>
                  )}
                  
                  {boat.activeCheckIns.length > 0 && (
                    <div class="text-sm text-blue-600">
                      Núna í útgáfu hjá: {boat.activeCheckIns[0].sailor_name}
                    </div>
                  )}
                  
                  <div class="mt-3">
                    <label for={`status-${boat.id}`} class="block text-sm font-medium text-gray-700 mb-1">
                      Breyta stöðu
                    </label>
                    <select
                      id={`status-${boat.id}`}
                      onchange={`updateBoatStatus('${boat.id}', this.value)`}
                      class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ocean-green focus:border-transparent"
                    >
                      <option value="operational" selected={boat.status === 'operational'}>
                        Tilbúinn
                      </option>
                      <option value="maintenance" selected={boat.status === 'maintenance'}>
                        Viðhald
                      </option>
                      <option value="out_of_service" selected={boat.status === 'out_of_service'}>
                        Ekki í notkun
                      </option>
                    </select>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="bg-sail-white rounded-lg p-6 shadow-lg">
            <h3 class="text-xl font-bold text-ocean-green mb-6">Nýleg starfsemi</h3>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              {notifications.map((notification) => (
                <div class="border-l-4 border-ocean-green pl-4 py-2">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <p class="text-sm font-medium">{notification.message}</p>
                      <p class="text-xs text-gray-500">
                        {new Date(notification.sent_at).toLocaleString('is-IS')}
                      </p>
                    </div>
                    <span class={`px-2 py-1 rounded text-xs ${
                      notification.type === 'check_out' ? 'bg-blue-100 text-blue-800' :
                      notification.type === 'check_in' ? 'bg-green-100 text-green-800' :
                      notification.type === 'status_change' ? 'bg-yellow-100 text-yellow-800' :
                      notification.type === 'time_extension' ? 'bg-purple-100 text-purple-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {notification.type === 'check_out' ? 'útgáfa' :
                       notification.type === 'check_in' ? 'innskráning' :
                       notification.type === 'status_change' ? 'stöðubreyting' :
                       notification.type === 'time_extension' ? 'tímaframlenging' :
                       notification.type}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    async function updateBoatStatus(boatId, status) {
      const notes = prompt('Bæta við athugasemdum (valfrjálst):');
      
      try {
        // Show loading state
        const selectElement = document.getElementById(`status-${boatId}`);
        const originalValue = selectElement.value;
        selectElement.disabled = true;
        
        const response = await fetch('/api/update-boat-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ boatId, status, notes })
        });
        
        if (response.ok) {
          // Show success feedback
          selectElement.classList.add('bg-green-50', 'border-green-500');
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          // Revert to original value on error
          selectElement.value = originalValue;
          selectElement.disabled = false;
          alert('Villa við að uppfæra bátastöðu');
        }
      } catch (error) {
        console.error('Error:', error);
        // Revert to original value on error
        const selectElement = document.getElementById(`status-${boatId}`);
        selectElement.value = originalValue;
        selectElement.disabled = false;
        alert('Villa við að uppfæra bátastöðu');
      }
    }
  </script>
</Layout> 