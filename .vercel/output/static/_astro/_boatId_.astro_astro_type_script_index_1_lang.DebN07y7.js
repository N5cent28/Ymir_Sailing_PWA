const i=document.querySelector("[data-boat-id]").getAttribute("data-boat-id"),s=document.getElementById("checkInForm"),u=document.getElementById("message"),y=document.getElementById("extensionOptions"),I=document.getElementById("extensionButtons"),C=document.getElementById("declineExtension"),f=document.getElementById("easyCheckIn"),g=document.getElementById("activeCheckInInfo"),T=document.getElementById("checkInButton"),L=document.getElementById("takeBoatOverButton"),E=document.getElementById("takeBoatOverForm"),p=document.getElementById("takeOverForm"),N=document.getElementById("cancelTakeOver"),O=document.getElementById("memberNumber"),M=document.getElementById("name"),S=document.getElementById("phone"),D=document.getElementById("lookupMember"),$=document.getElementById("takeOverMemberNumber"),j=document.getElementById("takeOverName"),A=document.getElementById("takeOverPhone"),F=document.getElementById("takeOverLookupMember"),l=document.getElementById("boatSelection");function P(){l&&(l.value=i,l.addEventListener("change",R))}async function R(){const t=l.value;if(t)try{const n=await(await fetch(`/api/boat-status?boatId=${t}`)).json(),r=document.getElementById("boatInfo");r&&n.boat&&(r.textContent=`Boat: ${n.boat.name}`),document.body.setAttribute("data-boat-id",t),console.log("üîç Boat selection changed to:",t)}catch(e){console.error("Error fetching boat status:",e)}}P();async function x(){try{const e=await(await fetch(`/api/check-in?boatId=${i}`)).json();console.log("üîç ACTIVE CHECK-INS:",e.activeCheckIns),e.activeCheckIns&&e.activeCheckIns.length>0?(console.log("üîç Found active check-ins:",e.activeCheckIns.length),e.activeCheckIns.forEach((n,r)=>{console.log(`- Check-in ${r+1}:`,n.sailor_name,"ID:",n.id,"Status:",n.actual_return?"Completed":"Active")}),i==="kayak"||i==="paddle-board"?H(e.activeCheckIns):_(e.activeCheckIns[0])):console.log("üîç No active check-ins found")}catch(t){console.error("Error checking active check-ins:",t)}}function H(t){const e=document.createElement("div");e.className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",e.innerHTML=`
          <h4 class="text-sm font-semibold text-blue-900 mb-2">Currently Active Check-ins (${t.length})</h4>
          <div class="space-y-2">
            ${t.map(n=>`
              <div class="text-xs text-blue-800">
                <strong>${n.sailor_name}</strong> - Expected back: ${new Date(n.expected_return).toLocaleString()}
              </div>
            `).join("")}
          </div>
          <p class="text-xs text-blue-600 mt-2">This is a shared boat. You can still check it out!</p>
        `,s&&s.parentNode.insertBefore(e,s)}function _(t){const e=new Date(t.departure_time).toLocaleString(),n=new Date(t.expected_return).toLocaleString();g.innerHTML=`
          <div class="text-sm">
            <p><strong>Sailor:</strong> ${t.sailor_name}</p>
            <p><strong>Departure:</strong> ${e}</p>
            <p><strong>Expected Return:</strong> ${n}</p>
          </div>
        `,g.dataset.checkInId=t.id,f.classList.remove("hidden"),s&&s.classList.add("hidden")}T.addEventListener("click",async()=>{try{const e=await(await fetch("/api/check-out",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({checkInId:g.dataset.checkInId})})).json();e.success?(o(e.message,"success"),f.classList.add("hidden")):o(e.error,"error")}catch(t){console.error("Error checking in:",t),o("An error occurred while checking in.","error")}});L.addEventListener("click",()=>{f.classList.add("hidden"),E.classList.remove("hidden");const t=new Date,e=new Date(t.getTime()+7200*1e3),n=new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("takeOverReturn").value=n});N.addEventListener("click",()=>{E.classList.add("hidden"),f.classList.remove("hidden")});F.addEventListener("click",async()=>{const t=$.value.trim();if(!t){o("Please enter a member number","error");return}try{const n=await(await fetch(`/api/check-in?memberNumber=${t}`)).json();n.found?(j.value=n.member.name,n.member.phone&&(A.value=n.member.phone),o("Member information loaded!","success")):o("Member number not found","error")}catch(e){console.error("Error looking up member:",e),o("Error looking up member","error")}});D.addEventListener("click",async()=>{const t=O.value.trim();if(!t){o("Please enter a member number","error");return}try{const n=await(await fetch(`/api/check-in?memberNumber=${t}`)).json();n.found?(M.value=n.member.name,n.member.phone&&(S.value=n.member.phone),o("Member information loaded!","success")):o("Member number not found","error")}catch(e){console.error("Error looking up member:",e),o("Error looking up member","error")}});async function B(){try{const e=await(await fetch(`/api/extend-time?boatId=${i}`)).json();e.hasActiveCheckIn&&e.isNearReturn&&J(e)}catch(t){console.error("Error checking extension options:",t)}}function J(t){I.innerHTML="",t.extensionOptions.forEach(e=>{const n=document.createElement("button");n.type="button",n.className="w-full px-4 py-2 bg-ocean-green text-white rounded hover:bg-green-700 transition-colors mb-2",n.textContent=`Extend by ${e.label}`,n.onclick=()=>V(t.checkIn.id,e.newTime),I.appendChild(n)}),y.classList.remove("hidden"),s&&s.classList.add("hidden")}async function V(t,e){try{const r=await(await fetch("/api/extend-time",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({checkInId:t,newReturnTime:e})})).json();r.success?(o(r.message,"success"),y.classList.add("hidden"),setTimeout(()=>location.reload(),2e3)):o(r.error,"error")}catch(n){console.error("Error extending time:",n),o("An error occurred while extending time.","error")}}function o(t,e){u.className="mt-4 p-3 rounded-lg",u.className+=e==="success"?" bg-green-100 text-green-800":" bg-red-100 text-red-800",u.textContent=t,u.classList.remove("hidden"),setTimeout(()=>{u.classList.add("hidden")},5e3)}C.addEventListener("click",()=>{y.classList.add("hidden"),s&&s.classList.remove("hidden")});B();x();setInterval(B,3e4);setInterval(x,3e4);function z(){const t=document.getElementById("return");if(t){const e=new Date,n=new Date(e.getTime()+7200*1e3),r=new Date(n.getTime()-n.getTimezoneOffset()*6e4).toISOString().slice(0,16);t.value=r}}z();s&&s.addEventListener("submit",async t=>{t.preventDefault();const e=document.querySelectorAll('input[name="safetyChecklist"]');if(!Array.from(e).every(d=>d.checked)){o("Please complete all safety checklist items before checking out the boat.","error");return}const r=new FormData(s),a=l?l.value:i;if(!a){o("Please select a boat to check out.","error");return}const b={boatId:a,sailorName:r.get("name"),memberNumber:r.get("memberNumber")||null,phone:r.get("phone")||null,expectedReturn:r.get("return"),safetyChecklist:!0};try{const c=await(await fetch("/api/check-in",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})).json();if(c.success){const m=document.getElementById("pageTitle"),h=document.getElementById("boatInfo"),w=document.getElementById("successMessage"),k=document.getElementById("checkInForm");m.textContent=`${c.boatName} checked out successfully!`,m.className="text-2xl font-bold text-green-600 mb-2",h.style.display="none",w.classList.remove("hidden");const v=document.getElementById("profileLinkContainer");c.memberNumber?v.innerHTML=`
                  <div class="flex space-x-3 justify-center mb-4">
                    <a href="/en/profile?memberNumber=${c.memberNumber}" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                      View My Profile
                    </a>
                    <a href="/en/" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                      Go Home
                    </a>
                  </div>
                  <div class="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg text-center">
                    <p class="text-orange-800 mb-3">Notice any issues with the boat?</p>
                    <button 
                      onclick="openMaintenanceModal('${a||i}', '${c.memberNumber}')"
                      class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors"
                    >
                      üîß Report Maintenance Issue
                    </button>
                  </div>
                `:v.innerHTML="",k&&(k.style.display="none"),o(c.message,"success"),s.reset()}else o(c.error,"error")}catch(d){console.error("üîç FETCH ERROR:"),console.error("- Error type:",d.name),console.error("- Error message:",d.message),console.error("- Error stack:",d.stack),o("An error occurred. Please try again.","error")}});p&&p.addEventListener("submit",async t=>{t.preventDefault();const e=new FormData(p),n={boatId:i,sailorName:e.get("name"),expectedReturn:e.get("return"),takeOver:!0,previousCheckInId:g.dataset.checkInId};console.log("üîç TAKEOVER: Form data being sent:",n),console.log("- previousCheckInId from dataset:",g.dataset.checkInId);try{const a=await(await fetch("/api/check-in",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json();if(a.success){const b=document.getElementById("pageTitle"),d=document.getElementById("boatInfo"),c=document.getElementById("successMessage"),m=document.getElementById("takeBoatOverForm");b.textContent=`${a.boatName} checked out successfully!`,b.className="text-2xl font-bold text-green-600 mb-2",d.style.display="none",c.classList.remove("hidden");const h=document.getElementById("profileLinkContainer");a.memberNumber?h.innerHTML=`
                  <div class="flex space-x-3 justify-center mb-4">
                    <a href="/en/profile?memberNumber=${a.memberNumber}" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                      View My Profile
                    </a>
                    <a href="/en/" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                      Go Home
                    </a>
                  </div>
                  <div class="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg text-center">
                    <p class="text-orange-800 mb-3">Notice any issues with the boat?</p>
                    <button 
                      onclick="openMaintenanceModal('${i}', '${a.memberNumber}')"
                      class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors"
                    >
                      üîß Report Maintenance Issue
                    </button>
                  </div>
                `:h.innerHTML="",m&&(m.style.display="none"),o(a.message,"success"),p.reset(),setTimeout(()=>{location.reload()},3e3)}else o(a.error,"error")}catch(r){console.error("Error:",r),o("An error occurred. Please try again.","error")}});
