---
import Layout from '../../layouts/Layout.astro';
import Navigation from '../../components/Navigation.astro';
import MaintenanceModal from '../../components/MaintenanceModal.astro';
---

<Layout title="M√≠n Virki B√°tur - Siglingaf√©lagi√∞ √ùmir" lang="is">
  <Navigation />
  
  <main>
    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-ocean-green to-green-600 text-white py-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="text-5xl font-bold mb-6">
          M√≠n Virki B√°tur
        </h1>
        <p class="text-xl mb-8 max-w-3xl mx-auto">
          Skr√°√∞u √æig inn √° b√°tinn √æinn me√∞ me√∞limsn√∫meri. Engin QR-k√≥√∞i √æarf!
        </p>
      </div>
    </section>

    <!-- Member Lookup Section -->
    <section class="py-16 bg-white">
      <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-ocean-green mb-6">Finndu Virka B√°tinn</h2>
          
          <!-- Member Number Input -->
          <div class="mb-6">
            <label for="memberNumber" class="block text-sm font-medium text-anchor-gray mb-2">
              Me√∞limsn√∫mer
            </label>
            <div class="flex gap-2">
              <input
                type="text"
                id="memberNumber"
                placeholder="Sl√°√∞u inn me√∞limsn√∫meri√∞ √æitt"
                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ocean-green"
              />
              <button
                id="findBoat"
                class="px-6 py-3 bg-ocean-green text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
              >
                Finna B√°t
              </button>
            </div>
          </div>

          <!-- Loading State -->
          <div id="loading" class="hidden text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-ocean-green mx-auto mb-4"></div>
            <p class="text-anchor-gray">Leita a√∞ virka b√°tnum √æ√≠num...</p>
          </div>

          <!-- Active Boat Display -->
          <div id="activeBoat" class="hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
              <h3 class="text-lg font-semibold text-green-900 mb-4">Virkur B√°turinn √ûinn</h3>
              <div id="boatInfo" class="space-y-3 mb-6">
                <!-- Boat information will be populated here -->
              </div>
              
              <!-- Action Buttons -->
              <div class="flex gap-3 mb-6">
                <button
                  id="checkInButton"
                  class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
                >
                  ‚úÖ Skr√° Inn N√∫na
                </button>
                <button
                  onclick="openMaintenanceModalFromMyBoat()"
                  class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold"
                >
                  üîß Skr√° Vi√∞haldsvandam√°l
                </button>
              </div>
            </div>
          </div>

          <!-- No Active Boat -->
          <div id="noActiveBoat" class="hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
              <div class="text-4xl mb-4">üö§</div>
              <h3 class="text-lg font-semibold text-blue-900 mb-2">Enginn Virkur B√°tur Fannst</h3>
              <p class="text-blue-800 mb-4">
                √ûa√∞ l√≠tur √∫t fyrir a√∞ √æ√∫ hafir enga b√°ta √≠ notkun! Ef √æ√∫ vilt fara a√∞ sigla, far√∞u yfir √≠ b√°ta sv√¶√∞i√∞ til a√∞ f√° b√°t.
              </p>
              <div class="space-y-3">
                <a href="/is/qr-codes" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                  Sko√∞a Alla B√°ta
                </a>
                <div class="text-sm text-blue-600">
                  <p>√ûarftu hj√°lp? Haf√∞u samband vi√∞ skrifstofuna.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Error Message -->
          <div id="error" class="hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
              <div class="text-4xl mb-4">‚ùå</div>
              <h3 class="text-lg font-semibold text-red-900 mb-2">Villa</h3>
              <p id="errorMessage" class="text-red-800">
                Villa kom upp. Vinsamlegast reyndu aftur.
              </p>
            </div>
          </div>

          <!-- Success Message -->
          <div id="success" class="hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
              <div class="text-4xl mb-4">‚úÖ</div>
              <h3 class="text-lg font-semibold text-green-900 mb-2">T√≥kst a√∞ Skr√° Inn!</h3>
              <p class="text-green-800 mb-4">
                B√°turinn √æinn hefur veri√∞ skr√°√∞ur inn me√∞ g√≥√∞um √°rangri. Takk fyrir a√∞ nota Siglingaf√©lagi√∞ √ùmir!
              </p>
              <a href="/is" class="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                Aftur √° Fors√≠√∞u
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <MaintenanceModal />

    <script>
      const memberNumberInput = document.getElementById('memberNumber');
      const findBoatBtn = document.getElementById('findBoat');
      const loading = document.getElementById('loading');
      const activeBoat = document.getElementById('activeBoat');
      const noActiveBoat = document.getElementById('noActiveBoat');
      const error = document.getElementById('error');
      const success = document.getElementById('success');
      const boatInfo = document.getElementById('boatInfo');
      const checkInButton = document.getElementById('checkInButton');
      const errorMessage = document.getElementById('errorMessage');

      let currentCheckInId = null;
      let currentBoatId = null;

      // Handle find boat button click
      findBoatBtn.addEventListener('click', async () => {
        const memberNumber = memberNumberInput.value.trim();
        
        if (!memberNumber) {
          showError('Vinsamlegast sl√°√∞u inn me√∞limsn√∫meri√∞ √æitt');
          return;
        }

        showLoading();
        
        try {
          console.log('üîç Searching for boat with member number:', memberNumber);
          const response = await fetch(`/api/my-active-boat?memberNumber=${memberNumber}`);
          console.log('üì° Response status:', response.status);
          
          const data = await response.json();
          console.log('üì° Response data:', data);
          
          if (data.success) {
            if (data.activeBoat) {
              console.log('‚úÖ Found active boat, showing boat info');
              showActiveBoat(data.activeBoat);
            } else {
              console.log('‚úÖ No active boat found, showing no boat message');
              showNoActiveBoat();
            }
          } else {
            console.log('‚ùå API returned error:', data.error);
            showError(data.error || 'Mist√≥kst a√∞ finna virkan b√°tinn √æinn');
          }
        } catch (err) {
          console.error('‚ùå Error finding boat:', err);
          showError('Villa kom upp vi√∞ a√∞ leita a√∞ b√°ti');
        }
      });

      // Handle check-in button click
      checkInButton.addEventListener('click', async () => {
        if (!currentCheckInId) {
          showError('Enginn virkur b√°tur til a√∞ skr√° inn');
          return;
        }

        showLoading();
        
        try {
          const response = await fetch('/api/check-out', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ checkInId: currentCheckInId })
          });
          
          const result = await response.json();
          
          if (result.success) {
            showSuccess();
          } else {
            showError(result.error || 'Mist√≥kst a√∞ skr√° inn b√°t');
          }
        } catch (err) {
          console.error('Error checking in:', err);
          showError('Villa kom upp vi√∞ a√∞ skr√° inn');
        }
      });

      function showLoading() {
        hideAll();
        loading.classList.remove('hidden');
      }

      function showActiveBoat(boat) {
        hideAll();
        
        // Format times in user's local timezone with clear timezone info
        const departureTime = new Date(boat.departure_time).toLocaleString('is-IS', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZoneName: 'short'
        });
        const expectedReturn = new Date(boat.expected_return).toLocaleString('is-IS', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZoneName: 'short'
        });
        
        boatInfo.innerHTML = `
          <div class="grid grid-cols-1 gap-3">
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">B√°tur:</span>
              <span class="text-gray-900">${boat.boat_name}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">Siglingama√∞ur:</span>
              <span class="text-gray-900">${boat.sailor_name}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">Brottf√∂r:</span>
              <span class="text-gray-900">${departureTime}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-700">V√¶ntanlegur afturkomut√≠mi:</span>
              <span class="text-gray-900">${expectedReturn}</span>
            </div>
          </div>
        `;
        
        currentCheckInId = boat.id;
        currentBoatId = boat.boat_id;
        activeBoat.classList.remove('hidden');
      }

      function showNoActiveBoat() {
        console.log('üö§ Showing no active boat message');
        hideAll();
        noActiveBoat.classList.remove('hidden');
      }

      function showError(message) {
        hideAll();
        errorMessage.textContent = message;
        error.classList.remove('hidden');
      }

      function showSuccess() {
        hideAll();
        success.classList.remove('hidden');
        setTimeout(() => {
          success.classList.add('hidden');
        }, 5000); // Hide success message after 5 seconds
      }

      function hideAll() {
        console.log('üîÑ Hiding all sections');
        loading.classList.add('hidden');
        activeBoat.classList.add('hidden');
        noActiveBoat.classList.add('hidden');
        error.classList.add('hidden');
        success.classList.add('hidden');
      }

      // Allow Enter key to submit
      memberNumberInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          findBoatBtn.click();
        }
      });

      // Maintenance modal callback
      window.onMaintenanceReported = function() {
        alert('Vi√∞haldsvandam√°l skr√°√∞ me√∞ g√≥√∞um √°rangri! Sta√∞a b√°tsins hefur veri√∞ uppf√¶r√∞.');
        // Don't reload the page - keep the current state
      };

      // Function to open maintenance modal
      window.openMaintenanceModalFromMyBoat = function() {
        const memberNumber = memberNumberInput.value.trim();
        if (window.openMaintenanceModal && currentBoatId && memberNumber) {
          window.openMaintenanceModal(currentBoatId, memberNumber);
        } else {
          alert('Vinsamlegast sl√°√∞u inn me√∞limsn√∫meri√∞ √æitt og finndu b√°tinn √æinn fyrst.');
        }
      };
    </script>
  </main>
</Layout> 