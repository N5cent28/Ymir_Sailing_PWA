---
// Admin Notification Debugging Page
import Layout from '../layouts/Layout.astro';
---

<Layout title="Admin Notification Debugging - Ymir Sailing Club">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üîß Admin Notification Debugging</h1>
            <p class="text-gray-600">Comprehensive testing and debugging tools for push notifications</p>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-500">Current Domain</div>
            <div class="font-mono text-lg font-semibold text-blue-600" id="currentDomain">Loading...</div>
          </div>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-8">
        <!-- System Status -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <span class="bg-green-100 text-green-800 rounded-full p-2 mr-3">üìä</span>
            System Status
          </h2>
          
          <div class="space-y-4">
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
              <span class="font-medium">Notification Support</span>
              <span id="notificationSupport" class="px-3 py-1 rounded-full text-sm font-medium">Checking...</span>
            </div>
            
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
              <span class="font-medium">Service Worker</span>
              <span id="serviceWorkerStatus" class="px-3 py-1 rounded-full text-sm font-medium">Checking...</span>
            </div>
            
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
              <span class="font-medium">Push Subscription</span>
              <span id="pushSubscriptionStatus" class="px-3 py-1 rounded-full text-sm font-medium">Checking...</span>
            </div>
            
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
              <span class="font-medium">User Agent</span>
              <span id="userAgent" class="text-xs text-gray-600 font-mono">Loading...</span>
            </div>
          </div>
          
          <div class="mt-6 pt-6 border-t border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-3">Quick Actions</h3>
            <div class="space-y-2">
              <button onclick="requestNotificationPermission()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                üîî Request Notification Permission
              </button>
            <button onclick="debugSubscriptions()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
              üìä Debug Subscriptions
            </button>
            <button onclick="testDirectNotification()" class="w-full px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors text-sm">
              üîî Test Direct Notification
            </button>
            </div>
          </div>
        </div>

        <!-- Notification Testing -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <span class="bg-blue-100 text-blue-800 rounded-full p-2 mr-3">üß™</span>
            Notification Testing
          </h2>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Member Number (optional)</label>
            <input type="text" id="memberNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 1234">
            <p class="text-xs text-gray-500 mt-1">Leave empty to test all users</p>
          </div>
          
          <div class="space-y-3">
            <button onclick="testNotification('test')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
              üì¢ Basic Test Notification
            </button>
            
            <button onclick="testNotification('checkout')" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
              ‚õµ Boat Checkout Confirmation
            </button>
            
            <button onclick="testNotification('reminder')" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
              ‚è∞ Time Extension Reminder
            </button>
            
            <button onclick="testNotification('overdue')" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
              üö® Overdue Boat Alert
            </button>
          </div>
        </div>

        <!-- Subscription Management -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <span class="bg-purple-100 text-purple-800 rounded-full p-2 mr-3">üîó</span>
            Subscription Management
          </h2>
          
          <div class="space-y-3">
            <button onclick="fixSubscriptionLink()" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
              üîó Fix Subscription Link
            </button>
            
            <button onclick="testNotificationSystem()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
              üîç Test Notification System
            </button>
          </div>
        </div>

        <!-- Advanced Admin Tools -->
        <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-red-500">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <span class="bg-red-100 text-red-800 rounded-full p-2 mr-3">‚ö†Ô∏è</span>
            Advanced Admin Tools
          </h2>
          
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
            <div class="flex items-start">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Warning</h3>
                <div class="mt-2 text-sm text-red-700">
                  <p>These actions affect all users and should only be used for testing purposes.</p>
                </div>
              </div>
            </div>
          </div>
          
          <button onclick="deleteAllSubscriptions()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">
            üóëÔ∏è Delete All Subscriptions
          </button>
          
          <p class="text-xs text-gray-500 mt-2">
            This simulates all users logging out by removing all push notification subscriptions from the database.
          </p>
        </div>
      </div>

      <!-- Status Display -->
      <div class="mt-8">
        <div id="status" class="hidden"></div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    window.isTesting = false;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
    });
    
    function initializePage() {
      // Set current domain
      document.getElementById('currentDomain').textContent = window.location.origin;
      
      // Check system status
      checkNotificationSupport();
      checkServiceWorker();
      checkPushSubscription();
      updateUserAgent();
    }
    
    function updateUserAgent() {
      document.getElementById('userAgent').textContent = navigator.userAgent;
    }
    
    function updateStatus(elementId, status, isSuccess = true) {
      const element = document.getElementById(elementId);
      element.textContent = status;
      element.className = `px-3 py-1 rounded-full text-sm font-medium ${
        isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
      }`;
    }
    
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `p-4 rounded-lg ${
        type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
        type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' :
        'bg-blue-50 text-blue-800 border border-blue-200'
      }`;
      statusDiv.textContent = message;
      statusDiv.classList.remove('hidden');
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.classList.add('hidden');
      }, 5000);
    }
    
    // System Status Functions
    window.checkNotificationSupport = async function() {
      if (!('Notification' in window)) {
        updateStatus('notificationSupport', 'Not Supported', false);
        return;
      }
      
      const permission = Notification.permission;
      let status = permission.charAt(0).toUpperCase() + permission.slice(1);
      updateStatus('notificationSupport', status, permission === 'granted');
    };
    
    window.checkServiceWorker = async function() {
      if (!('serviceWorker' in navigator)) {
        updateStatus('serviceWorkerStatus', 'Not Supported', false);
        return;
      }
      
      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        if (registrations.length > 0) {
          updateStatus('serviceWorkerStatus', `Registered (${registrations.length})`, true);
        } else {
          updateStatus('serviceWorkerStatus', 'Not Registered', false);
        }
      } catch (error) {
        updateStatus('serviceWorkerStatus', 'Error', false);
      }
    };
    
    window.checkPushSubscription = async function() {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        updateStatus('pushSubscriptionStatus', 'Not Supported', false);
        return;
      }
      
      try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          updateStatus('pushSubscriptionStatus', 'Active', true);
        } else {
          updateStatus('pushSubscriptionStatus', 'Not Active', false);
        }
      } catch (error) {
        updateStatus('pushSubscriptionStatus', 'Error', false);
      }
    };
    
    window.requestNotificationPermission = async function() {
      if (!('Notification' in window)) {
        showStatus('‚ùå This browser does not support notifications', 'error');
        return;
      }
      
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        showStatus('‚úÖ Notification permission granted!', 'success');
        checkNotificationSupport();
      } else {
        showStatus('‚ùå Notification permission denied', 'error');
      }
    };
    
    window.checkSystemStatus = function() {
      showStatus('üîÑ Checking system status...', 'info');
      checkNotificationSupport();
      checkServiceWorker();
      checkPushSubscription();
      showStatus('‚úÖ System status updated', 'success');
    };
    
    window.testDirectNotification = async function() {
      if (!('Notification' in window)) {
        showStatus('‚ùå This browser does not support notifications', 'error');
        return;
      }
      
      const permission = Notification.permission;
      if (permission !== 'granted') {
        showStatus('‚ùå Notification permission not granted. Please click "Request Notification Permission" first.', 'error');
        return;
      }
      
      try {
        showStatus('Sending direct browser notification...', 'info');
        
        const notification = new Notification('üß™ Direct Test Notification', {
          body: 'This is a direct browser notification test from Ymir Sailing Club!',
          icon: '/icon-192.svg',
          badge: '/icon-192.svg',
          vibrate: [200, 100, 200, 100, 200],
          tag: 'direct-test-notification',
          requireInteraction: true,
          silent: false,
          data: {
            type: 'direct_test',
            timestamp: new Date().toISOString()
          }
        });
        
        notification.onclick = function() {
          console.log('Direct notification clicked!');
          window.focus();
          notification.close();
        };
        
        notification.onshow = function() {
          console.log('‚úÖ Direct notification displayed successfully!');
          showStatus('‚úÖ Direct notification sent! Check your system notifications area.', 'success');
        };
        
        notification.onerror = function(error) {
          console.error('‚ùå Direct notification error:', error);
          showStatus('‚ùå Direct notification failed: ' + error.message, 'error');
        };
        
        // Auto-close after 5 seconds
        setTimeout(() => {
          notification.close();
        }, 5000);
        
      } catch (error) {
        showStatus('‚ùå Error creating direct notification: ' + error.message, 'error');
      }
    };
    
    // Notification Testing Functions
    window.testNotification = async function(type) {
      if (window.isTesting) return;
      
      window.isTesting = true;
      const memberNumber = document.getElementById('memberNumber').value.trim();
      
      showStatus('Sending test notification...', 'info');
      
      try {
        const url = `/api/test-notification?type=${type}${memberNumber ? `&memberNumber=${memberNumber}` : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
          showStatus(`‚úÖ Test notification sent successfully! Sent to ${data.sentTo} device(s)${data.failed > 0 ? `, ${data.failed} failed` : ''}`, 'success');
        } else {
          showStatus(`‚ùå Failed to send notification: ${data.error}`, 'error');
        }
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        window.isTesting = false;
      }
    };
    
    // Subscription Management Functions
    
    window.fixSubscriptionLink = async function() {
      const memberNumber = document.getElementById('memberNumber').value.trim();
      
      if (!memberNumber) {
        showStatus('‚ùå Please enter your member number first', 'error');
        return;
      }
      
      showStatus('Fixing subscription link...', 'info');
      
      try {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
          showStatus('‚ùå This browser does not support push notifications', 'error');
          return;
        }
        
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        if (!subscription) {
          showStatus('‚ùå No push subscription found. Please grant notification permission first.', 'error');
          return;
        }
        
        const response = await fetch('/api/push-subscription', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            subscription: subscription,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString(),
            memberNumber: memberNumber
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showStatus(`‚úÖ Subscription linked to member ${memberNumber}! Try testing notifications now.`, 'success');
        } else {
          showStatus(`‚ùå Failed to link subscription: ${data.error}`, 'error');
        }
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    };
    
    window.testNotificationSystem = async function() {
      showStatus('Testing notification system...', 'info');
      
      try {
        const response = await fetch('/api/notification-check?action=admin-test');
        const data = await response.json();
        
        if (data.success) {
          showStatus('‚úÖ Notification system test completed! Check console for details.', 'success');
        } else {
          showStatus(`‚ùå Notification system test failed: ${data.error}`, 'error');
        }
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    };
    
    window.debugSubscriptions = async function() {
      const memberNumber = document.getElementById('memberNumber').value.trim();
      
      showStatus('Checking subscription database...', 'info');
      
      try {
        const url = `/api/test-notification?debug=true${memberNumber ? `&memberNumber=${memberNumber}` : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
          let message = `üìä Subscription Debug Info:\n`;
          message += `Total subscriptions: ${data.totalSubscriptions}\n`;
          message += `Your subscriptions: ${data.memberSubscriptions}\n`;
          message += `Member number: ${data.memberNumber || 'Not specified'}\n\n`;
          message += `All subscriptions:\n`;
          
          data.allSubscriptions.forEach((sub, index) => {
            message += `${index + 1}. Member ${sub.member_number || 'null'} - ${sub.endpoint}\n`;
            message += `   User Agent: ${sub.user_agent}\n`;
            message += `   Created: ${new Date(sub.created_at).toLocaleString()}\n\n`;
          });
          
          showStatus(message, 'info');
        } else {
          showStatus(`‚ùå Debug failed: ${data.error}`, 'error');
        }
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    };
    
    // Advanced Admin Functions
    window.deleteAllSubscriptions = async function() {
      if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL push notification subscriptions from the database, simulating all users logging out. This action cannot be undone. Are you sure you want to continue?')) {
        return;
      }
      
      showStatus('Deleting all subscriptions...', 'info');
      
      try {
        const adminMember = localStorage.getItem('adminMember');
        if (!adminMember) {
          showStatus('‚ùå Admin authentication required. Please log in as admin first.', 'error');
          return;
        }
        
        const member = JSON.parse(adminMember);
        
        const response = await fetch('/api/delete-all-subscriptions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ adminMember: member })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showStatus(`‚úÖ Successfully deleted ${data.deletedCount} push subscriptions! All users will need to log in again to receive notifications.`, 'success');
        } else {
          showStatus(`‚ùå Failed to delete subscriptions: ${data.error}`, 'error');
        }
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    };
  </script>
</Layout>